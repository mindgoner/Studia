{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "56fb8d1b-46b0-4379-a5c3-bd148bfa2fd3",
   "metadata": {},
   "source": [
    "# Zajęcie 6. System ekspertowy"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9fe867df-123b-433a-9760-1cd7903a478e",
   "metadata": {},
   "source": [
    "## Reprezentacja reguł"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "0d01917b-f514-4338-8c36-068ee9ee9e42",
   "metadata": {},
   "outputs": [],
   "source": [
    "rules = [\n",
    "    {\n",
    "        \"if\": lambda p: p[\"systolic_bp\"] >= 140 and p[\"diastolic_bp\"] >= 90,\n",
    "        \"then\": \"Hypertension\",\n",
    "        \"weight\": 0.9\n",
    "    },\n",
    "    {\n",
    "        \"if\": lambda p: p[\"bmi\"] >= 30,\n",
    "        \"then\": \"Obesity\",\n",
    "        \"weight\": 0.8\n",
    "    },\n",
    "    {\n",
    "        \"if\": lambda p: p[\"glucose\"] >= 126,\n",
    "        \"then\": \"Diabetes\",\n",
    "        \"weight\": 0.85\n",
    "    },\n",
    "    {\n",
    "        \"if\": lambda p: p[\"age\"] >= 65 and p[\"systolic_bp\"] >= 140,\n",
    "        \"then\": \"High cardiovascular risk\",\n",
    "        \"weight\": 0.7\n",
    "    }\n",
    "]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "48710125-a801-4bbe-8948-4350a2c89fcc",
   "metadata": {},
   "source": [
    "## Mechanizm wnioskowania"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "7b4dc0a5-d3b7-4653-8257-b7a7a38fe6f8",
   "metadata": {},
   "outputs": [],
   "source": [
    "def expert_system(patient, rules):\n",
    "    conclusions = {}\n",
    "\n",
    "    for rule in rules:\n",
    "        if rule[\"if\"](patient):\n",
    "            diagnosis = rule[\"then\"]\n",
    "            weight = rule[\"weight\"]\n",
    "            conclusions[diagnosis] = max(\n",
    "                conclusions.get(diagnosis, 0), weight\n",
    "            )\n",
    "\n",
    "    return conclusions"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d9713ff2-65b6-44ff-b418-eb3758c0b910",
   "metadata": {},
   "source": [
    "## Przykład użycia"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "dd9df085-6b08-4296-9f60-16818b0829f3",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Hypertension: confidence=0.9\n",
      "Obesity: confidence=0.8\n",
      "High cardiovascular risk: confidence=0.7\n"
     ]
    }
   ],
   "source": [
    "patient = {\n",
    "    \"age\": 68,\n",
    "    \"bmi\": 31.2,\n",
    "    \"systolic_bp\": 155,\n",
    "    \"diastolic_bp\": 95,\n",
    "    \"glucose\": 110\n",
    "}\n",
    "\n",
    "results = expert_system(patient, rules)\n",
    "\n",
    "for diagnosis, confidence in results.items():\n",
    "    print(f\"{diagnosis}: confidence={confidence}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "39f5daf6-b455-49e4-8f99-2d44837e9533",
   "metadata": {},
   "source": [
    "# Reguły rozmyte"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "ed419ba8-390a-4435-8797-b8bd2012259d",
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "\n",
    "def trimf(x, a, b, c):\n",
    "    \"\"\"Triangular membership function.\"\"\"\n",
    "    x = np.asarray(x)\n",
    "    y = np.zeros_like(x, dtype=float)\n",
    "    # rising edge\n",
    "    idx = (a < x) & (x < b)\n",
    "    y[idx] = (x[idx] - a) / (b - a)\n",
    "    # peak\n",
    "    y[x == b] = 1.0\n",
    "    # falling edge\n",
    "    idx = (b < x) & (x < c)\n",
    "    y[idx] = (c - x[idx]) / (c - b)\n",
    "    return np.clip(y, 0, 1)\n",
    "\n",
    "def trapmf(x, a, b, c, d):\n",
    "    \"\"\"Trapezoidal membership function.\"\"\"\n",
    "    x = np.asarray(x)\n",
    "    y = np.zeros_like(x, dtype=float)\n",
    "    # rising\n",
    "    idx = (a < x) & (x < b)\n",
    "    y[idx] = (x[idx] - a) / (b - a)\n",
    "    # top\n",
    "    idx = (b <= x) & (x <= c)\n",
    "    y[idx] = 1.0\n",
    "    # falling\n",
    "    idx = (c < x) & (x < d)\n",
    "    y[idx] = (d - x[idx]) / (d - c)\n",
    "    return np.clip(y, 0, 1)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "572c6b34-e396-4f5f-8c2c-2268f9fb1a9d",
   "metadata": {},
   "source": [
    "## Zbiory rozmyte dla wejść i wyjść"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "44d370fe-36b2-4616-b5d1-d1ebde711474",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Uniwersa (zakresy) dla zmiennych\n",
    "SBP = np.linspace(80, 200, 121)    # 80..200\n",
    "DBP = np.linspace(40, 120, 81)     # 40..120\n",
    "AGE = np.linspace(18, 90, 73)      # 18..90\n",
    "RISK = np.linspace(0, 100, 101)    # 0..100\n",
    "\n",
    "# Funkcje przynależności SBP\n",
    "def sbp_low(x):    return trapmf([x], 80, 80, 110, 125)[0]\n",
    "def sbp_high(x):   return trapmf([x], 135, 145, 200, 200)[0]\n",
    "def sbp_border(x): return trimf([x], 120, 135, 150)[0]\n",
    "\n",
    "# Funkcje przynależności DBP\n",
    "def dbp_low(x):    return trapmf([x], 40, 40, 75, 85)[0]\n",
    "def dbp_high(x):   return trapmf([x], 85, 90, 120, 120)[0]\n",
    "def dbp_border(x): return trimf([x], 80, 88, 96)[0]\n",
    "\n",
    "# Wiek\n",
    "def age_young(x):  return trapmf([x], 18, 18, 30, 40)[0]\n",
    "def age_old(x):    return trapmf([x], 55, 65, 90, 90)[0]\n",
    "def age_mid(x):    return trimf([x], 35, 50, 65)[0]\n",
    "\n",
    "# Wyjście: risk (zbiory rozmyte)\n",
    "risk_low    = trimf(RISK, 0, 20, 40)\n",
    "risk_medium = trimf(RISK, 30, 50, 70)\n",
    "risk_high   = trimf(RISK, 60, 80, 100)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "02c7401d-32df-4604-9621-ab20b4870a61",
   "metadata": {},
   "source": [
    "## Reguły rozmyte (Mamdani): min–max + centroid"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "d6dab8e9-ab02-44b1-aba3-6e57516a9cd5",
   "metadata": {},
   "outputs": [],
   "source": [
    "def mamdani_infer(patient):\n",
    "    sbp = patient[\"systolic_bp\"]\n",
    "    dbp = patient[\"diastolic_bp\"]\n",
    "    age = patient[\"age\"]\n",
    "\n",
    "    # Stopnie przynależności wejść\n",
    "    mu_sbp_low = sbp_low(sbp)\n",
    "    mu_sbp_bor = sbp_border(sbp)\n",
    "    mu_sbp_hi  = sbp_high(sbp)\n",
    "\n",
    "    mu_dbp_low = dbp_low(dbp)\n",
    "    mu_dbp_bor = dbp_border(dbp)\n",
    "    mu_dbp_hi  = dbp_high(dbp)\n",
    "\n",
    "    mu_age_old = age_old(age)\n",
    "\n",
    "    # --- Reguła 1: SBP high OR DBP high -> risk high\n",
    "    r1 = max(mu_sbp_hi, mu_dbp_hi)\n",
    "\n",
    "    # --- Reguła 2: SBP border AND DBP border -> risk medium\n",
    "    r2 = min(mu_sbp_bor, mu_dbp_bor)\n",
    "\n",
    "    # --- Reguła 3: SBP low AND DBP low -> risk low\n",
    "    r3 = min(mu_sbp_low, mu_dbp_low)\n",
    "\n",
    "    # --- Reguła 4: age old AND (SBP border OR DBP border) -> risk high\n",
    "    r4 = min(mu_age_old, max(mu_sbp_bor, mu_dbp_bor))\n",
    "\n",
    "    # Implication: przycinanie zbiorów wyjściowych\n",
    "    out_low    = np.minimum(r3, risk_low)\n",
    "    out_medium = np.minimum(r2, risk_medium)\n",
    "    out_high   = np.minimum(max(r1, r4), risk_high)\n",
    "\n",
    "    # Agregacja: max\n",
    "    aggregated = np.maximum.reduce([out_low, out_medium, out_high])\n",
    "\n",
    "    # Defuzyfikacja: środek ciężkości (centroid)\n",
    "    if aggregated.sum() == 0:\n",
    "        crisp = 0.0\n",
    "    else:\n",
    "        crisp = (RISK * aggregated).sum() / aggregated.sum()\n",
    "\n",
    "    debug = {\n",
    "        \"mu\": {\n",
    "            \"sbp_low\": mu_sbp_low, \"sbp_border\": mu_sbp_bor, \"sbp_high\": mu_sbp_hi,\n",
    "            \"dbp_low\": mu_dbp_low, \"dbp_border\": mu_dbp_bor, \"dbp_high\": mu_dbp_hi,\n",
    "            \"age_old\": mu_age_old\n",
    "        },\n",
    "        \"rules\": {\"r1\": r1, \"r2\": r2, \"r3\": r3, \"r4\": r4},\n",
    "        \"crisp_risk\": crisp\n",
    "    }\n",
    "    return crisp, aggregated, debug\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2375bd33-a4c2-43bd-b222-d8c8ee852bb7",
   "metadata": {},
   "source": [
    "## Przykład użycia + interpretacja „co zadziałało”"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "1e290345-44b4-4539-ab6b-a6f89878b863",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Crisp risk (0-100): 80.0\n",
      "Memberships: {'sbp_low': 0.0, 'sbp_border': 0.0, 'sbp_high': 1.0, 'dbp_low': 0.0, 'dbp_border': 0.125, 'dbp_high': 1.0, 'age_old': 1.0}\n",
      "Rule strengths: {'r1': 1.0, 'r2': 0.0, 'r3': 0.0, 'r4': 0.125}\n"
     ]
    }
   ],
   "source": [
    "patient = {\"age\": 68, \"systolic_bp\": 155, \"diastolic_bp\": 95}\n",
    "crisp, agg, dbg = mamdani_infer(patient)\n",
    "\n",
    "print(\"Crisp risk (0-100):\", round(crisp, 2))\n",
    "print(\"Memberships:\", {k: round(v, 3) for k, v in dbg[\"mu\"].items()})\n",
    "print(\"Rule strengths:\", {k: round(v, 3) for k, v in dbg[\"rules\"].items()})\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c87c898b-33a5-4793-b04b-59434ffc1678",
   "metadata": {},
   "source": [
    "## Szybkie mapowanie na etykietę (opcjonalnie)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "caef233b-2309-4817-afbe-7a4adf75ae20",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Risk label: high\n"
     ]
    }
   ],
   "source": [
    "def risk_label(crisp):\n",
    "    if crisp < 35:\n",
    "        return \"low\"\n",
    "    elif crisp < 65:\n",
    "        return \"medium\"\n",
    "    return \"high\"\n",
    "\n",
    "print(\"Risk label:\", risk_label(crisp))\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6510d160-e372-4fb1-8a03-57030669e6f8",
   "metadata": {},
   "source": [
    "# Rozwinięcie systemu o wyjaśnianie „dlaczego” (explainable expert system)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "0230713a-fc07-4c4a-bc5f-b9bf2faa6c64",
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "\n",
    "# ---------- Membership functions ----------\n",
    "def trimf(x, a, b, c):\n",
    "    x = np.asarray(x)\n",
    "    y = np.zeros_like(x, dtype=float)\n",
    "    idx = (a < x) & (x < b)\n",
    "    y[idx] = (x[idx] - a) / (b - a)\n",
    "    y[x == b] = 1.0\n",
    "    idx = (b < x) & (x < c)\n",
    "    y[idx] = (c - x[idx]) / (c - b)\n",
    "    return np.clip(y, 0, 1)\n",
    "\n",
    "def trapmf(x, a, b, c, d):\n",
    "    x = np.asarray(x)\n",
    "    y = np.zeros_like(x, dtype=float)\n",
    "    idx = (a < x) & (x < b)\n",
    "    y[idx] = (x[idx] - a) / (b - a)\n",
    "    idx = (b <= x) & (x <= c)\n",
    "    y[idx] = 1.0\n",
    "    idx = (c < x) & (x < d)\n",
    "    y[idx] = (d - x[idx]) / (d - c)\n",
    "    return np.clip(y, 0, 1)\n",
    "\n",
    "# ---------- Universes ----------\n",
    "RISK = np.linspace(0, 100, 101)\n",
    "\n",
    "# Output fuzzy sets\n",
    "risk_low    = trimf(RISK, 0, 20, 40)\n",
    "risk_medium = trimf(RISK, 30, 50, 70)\n",
    "risk_high   = trimf(RISK, 60, 80, 100)\n",
    "\n",
    "# ---------- Input fuzzy sets (single-point helpers) ----------\n",
    "def sbp_low(x):    return trapmf([x], 80, 80, 110, 125)[0]\n",
    "def sbp_border(x): return trimf([x], 120, 135, 150)[0]\n",
    "def sbp_high(x):   return trapmf([x], 135, 145, 200, 200)[0]\n",
    "\n",
    "def dbp_low(x):    return trapmf([x], 40, 40, 75, 85)[0]\n",
    "def dbp_border(x): return trimf([x], 80, 88, 96)[0]\n",
    "def dbp_high(x):   return trapmf([x], 85, 90, 120, 120)[0]\n",
    "\n",
    "def age_old(x):    return trapmf([x], 55, 65, 90, 90)[0]\n",
    "\n",
    "\n",
    "# ---------- Explainable fuzzy rule engine ----------\n",
    "def explainable_fuzzy_ht_risk(patient, explain_top_k=10):\n",
    "    sbp = float(patient[\"systolic_bp\"])\n",
    "    dbp = float(patient[\"diastolic_bp\"])\n",
    "    age = float(patient[\"age\"])\n",
    "\n",
    "    # memberships\n",
    "    mu = {\n",
    "        \"SBP_low\": sbp_low(sbp),\n",
    "        \"SBP_border\": sbp_border(sbp),\n",
    "        \"SBP_high\": sbp_high(sbp),\n",
    "        \"DBP_low\": dbp_low(dbp),\n",
    "        \"DBP_border\": dbp_border(dbp),\n",
    "        \"DBP_high\": dbp_high(dbp),\n",
    "        \"AGE_old\": age_old(age),\n",
    "    }\n",
    "\n",
    "    # helper ops\n",
    "    AND = min\n",
    "    OR = max\n",
    "\n",
    "    # --------- Define rules with human-readable templates ----------\n",
    "    rules = [\n",
    "        {\n",
    "            \"id\": \"R1\",\n",
    "            \"text\": \"Jeśli SBP jest WYSOKIE LUB DBP jest WYSOKIE, to ryzyko jest WYSOKIE.\",\n",
    "            \"strength\": OR(mu[\"SBP_high\"], mu[\"DBP_high\"]),\n",
    "            \"conclusion\": \"risk_high\",\n",
    "            \"out_set\": risk_high,\n",
    "            \"why\": {\n",
    "                \"SBP_high\": mu[\"SBP_high\"],\n",
    "                \"DBP_high\": mu[\"DBP_high\"],\n",
    "                \"operator\": \"OR\"\n",
    "            }\n",
    "        },\n",
    "        {\n",
    "            \"id\": \"R2\",\n",
    "            \"text\": \"Jeśli SBP jest GRANICZNE I DBP jest GRANICZNE, to ryzyko jest ŚREDNIE.\",\n",
    "            \"strength\": AND(mu[\"SBP_border\"], mu[\"DBP_border\"]),\n",
    "            \"conclusion\": \"risk_medium\",\n",
    "            \"out_set\": risk_medium,\n",
    "            \"why\": {\n",
    "                \"SBP_border\": mu[\"SBP_border\"],\n",
    "                \"DBP_border\": mu[\"DBP_border\"],\n",
    "                \"operator\": \"AND\"\n",
    "            }\n",
    "        },\n",
    "        {\n",
    "            \"id\": \"R3\",\n",
    "            \"text\": \"Jeśli SBP jest NISKIE I DBP jest NISKIE, to ryzyko jest NISKIE.\",\n",
    "            \"strength\": AND(mu[\"SBP_low\"], mu[\"DBP_low\"]),\n",
    "            \"conclusion\": \"risk_low\",\n",
    "            \"out_set\": risk_low,\n",
    "            \"why\": {\n",
    "                \"SBP_low\": mu[\"SBP_low\"],\n",
    "                \"DBP_low\": mu[\"DBP_low\"],\n",
    "                \"operator\": \"AND\"\n",
    "            }\n",
    "        },\n",
    "        {\n",
    "            \"id\": \"R4\",\n",
    "            \"text\": \"Jeśli wiek jest STARY I (SBP jest GRANICZNE LUB DBP jest GRANICZNE), to ryzyko jest WYSOKIE.\",\n",
    "            \"strength\": AND(mu[\"AGE_old\"], OR(mu[\"SBP_border\"], mu[\"DBP_border\"])),\n",
    "            \"conclusion\": \"risk_high\",\n",
    "            \"out_set\": risk_high,\n",
    "            \"why\": {\n",
    "                \"AGE_old\": mu[\"AGE_old\"],\n",
    "                \"SBP_border\": mu[\"SBP_border\"],\n",
    "                \"DBP_border\": mu[\"DBP_border\"],\n",
    "                \"operator\": \"AGE_old AND (SBP_border OR DBP_border)\"\n",
    "            }\n",
    "        }\n",
    "    ]\n",
    "\n",
    "    # --------- Implication (clipping) + aggregation ----------\n",
    "    clipped = []\n",
    "    for r in rules:\n",
    "        clipped_set = np.minimum(r[\"strength\"], r[\"out_set\"])\n",
    "        clipped.append(clipped_set)\n",
    "        r[\"clipped_area\"] = float(clipped_set.sum())  # proxy \"how much it contributed\"\n",
    "\n",
    "    aggregated = np.maximum.reduce(clipped) if clipped else np.zeros_like(RISK)\n",
    "\n",
    "    # Defuzzification (centroid)\n",
    "    if aggregated.sum() == 0:\n",
    "        crisp = 0.0\n",
    "    else:\n",
    "        crisp = float((RISK * aggregated).sum() / aggregated.sum())\n",
    "\n",
    "    # Additional interpretable metrics:\n",
    "    # how much each rule contributed in area terms (normalized)\n",
    "    total_area = sum(r[\"clipped_area\"] for r in rules) + 1e-12\n",
    "    for r in rules:\n",
    "        r[\"contribution_pct\"] = 100.0 * r[\"clipped_area\"] / total_area\n",
    "\n",
    "    # Sort rules by strength, then by contribution\n",
    "    rules_sorted = sorted(rules, key=lambda r: (r[\"strength\"], r[\"clipped_area\"]), reverse=True)[:explain_top_k]\n",
    "\n",
    "    # map to label\n",
    "    label = \"low\" if crisp < 35 else (\"medium\" if crisp < 65 else \"high\")\n",
    "\n",
    "    explanation = {\n",
    "        \"patient\": {\"age\": age, \"systolic_bp\": sbp, \"diastolic_bp\": dbp},\n",
    "        \"memberships\": mu,\n",
    "        \"rules_fired\": rules_sorted,\n",
    "        \"risk_crisp\": crisp,\n",
    "        \"risk_label\": label\n",
    "    }\n",
    "    return explanation\n",
    "\n",
    "\n",
    "def print_explanation(exp, decimals=3):\n",
    "    print(\"=== Explainable Fuzzy Expert System (HT Risk) ===\")\n",
    "    p = exp[\"patient\"]\n",
    "    print(f\"Pacjent: age={p['age']:.0f}, SBP={p['systolic_bp']:.0f}, DBP={p['diastolic_bp']:.0f}\")\n",
    "    print(f\"Wynik ryzyka: {exp['risk_crisp']:.2f} / 100  ->  etykieta: {exp['risk_label']}\")\n",
    "    print(\"\\nStopnie przynależności (0..1):\")\n",
    "    for k, v in exp[\"memberships\"].items():\n",
    "        print(f\"  - {k}: {v:.{decimals}f}\")\n",
    "\n",
    "    print(\"\\nNajbardziej aktywne reguły (dlaczego?):\")\n",
    "    for r in exp[\"rules_fired\"]:\n",
    "        print(f\"\\n[{r['id']}] {r['text']}\")\n",
    "        print(f\"  Siła reguły (strength): {r['strength']:.{decimals}f}\")\n",
    "        print(f\"  Udział w agregacji (proxy): {r['contribution_pct']:.1f}%\")\n",
    "        # show WHY details\n",
    "        why = r[\"why\"]\n",
    "        if r[\"id\"] == \"R1\":\n",
    "            print(f\"  Ponieważ: SBP_high={why['SBP_high']:.{decimals}f}, DBP_high={why['DBP_high']:.{decimals}f} (OR)\")\n",
    "        elif r[\"id\"] == \"R2\":\n",
    "            print(f\"  Ponieważ: SBP_border={why['SBP_border']:.{decimals}f}, DBP_border={why['DBP_border']:.{decimals}f} (AND)\")\n",
    "        elif r[\"id\"] == \"R3\":\n",
    "            print(f\"  Ponieważ: SBP_low={why['SBP_low']:.{decimals}f}, DBP_low={why['DBP_low']:.{decimals}f} (AND)\")\n",
    "        elif r[\"id\"] == \"R4\":\n",
    "            print(f\"  Ponieważ: AGE_old={why['AGE_old']:.{decimals}f}, SBP_border={why['SBP_border']:.{decimals}f}, DBP_border={why['DBP_border']:.{decimals}f}\")\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "acca5434-ce21-427a-818b-883dda4a4fbc",
   "metadata": {},
   "source": [
    "## Użycie na przykładzie + „dlaczego?”"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "539fae5d-ec1b-4588-87ce-cdc4912e16e8",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Explainable Fuzzy Expert System (HT Risk) ===\n",
      "Pacjent: age=68, SBP=155, DBP=95\n",
      "Wynik ryzyka: 80.00 / 100  ->  etykieta: high\n",
      "\n",
      "Stopnie przynależności (0..1):\n",
      "  - SBP_low: 0.000\n",
      "  - SBP_border: 0.000\n",
      "  - SBP_high: 1.000\n",
      "  - DBP_low: 0.000\n",
      "  - DBP_border: 0.125\n",
      "  - DBP_high: 1.000\n",
      "  - AGE_old: 1.000\n",
      "\n",
      "Najbardziej aktywne reguły (dlaczego?):\n",
      "\n",
      "[R1] Jeśli SBP jest WYSOKIE LUB DBP jest WYSOKIE, to ryzyko jest WYSOKIE.\n",
      "  Siła reguły (strength): 1.000\n",
      "  Udział w agregacji (proxy): 81.1%\n",
      "  Ponieważ: SBP_high=1.000, DBP_high=1.000 (OR)\n",
      "\n",
      "[R4] Jeśli wiek jest STARY I (SBP jest GRANICZNE LUB DBP jest GRANICZNE), to ryzyko jest WYSOKIE.\n",
      "  Siła reguły (strength): 0.125\n",
      "  Udział w agregacji (proxy): 18.9%\n",
      "  Ponieważ: AGE_old=1.000, SBP_border=0.000, DBP_border=0.125\n",
      "\n",
      "[R2] Jeśli SBP jest GRANICZNE I DBP jest GRANICZNE, to ryzyko jest ŚREDNIE.\n",
      "  Siła reguły (strength): 0.000\n",
      "  Udział w agregacji (proxy): 0.0%\n",
      "  Ponieważ: SBP_border=0.000, DBP_border=0.125 (AND)\n",
      "\n",
      "[R3] Jeśli SBP jest NISKIE I DBP jest NISKIE, to ryzyko jest NISKIE.\n",
      "  Siła reguły (strength): 0.000\n",
      "  Udział w agregacji (proxy): 0.0%\n",
      "  Ponieważ: SBP_low=0.000, DBP_low=0.000 (AND)\n"
     ]
    }
   ],
   "source": [
    "patient = {\"age\": 68, \"systolic_bp\": 155, \"diastolic_bp\": 95}\n",
    "exp = explainable_fuzzy_ht_risk(patient)\n",
    "print_explanation(exp)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cd0182ba-9c50-49ba-8094-3118611c2a14",
   "metadata": {},
   "source": [
    "## Opcjonalnie: zwracanie śladu rozumowania (trace) do raportu"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "5943c393-2bc1-4a98-aa84-4d8983799a5c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ryzyko = 80.0/100 (high).\n",
      "Najsilniejsza reguła: R1 (strength=1.00, wkład~81%).\n",
      "Jeśli SBP jest WYSOKIE LUB DBP jest WYSOKIE, to ryzyko jest WYSOKIE.\n"
     ]
    }
   ],
   "source": [
    "def explanation_text(exp):\n",
    "    lines = []\n",
    "    lines.append(f\"Ryzyko = {exp['risk_crisp']:.1f}/100 ({exp['risk_label']}).\")\n",
    "    top = exp[\"rules_fired\"][0]\n",
    "    lines.append(f\"Najsilniejsza reguła: {top['id']} (strength={top['strength']:.2f}, wkład~{top['contribution_pct']:.0f}%).\")\n",
    "    lines.append(top[\"text\"])\n",
    "    return \"\\n\".join(lines)\n",
    "\n",
    "print(explanation_text(exp))\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
